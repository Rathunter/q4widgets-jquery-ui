/* Widget: q4.api */
/* Version: 1.0.0 */
/* Compiled on 2015-01-14 */
!function(a){a.widget("q4.api",{options:{url:"",limit:0,skip:0,fetchAllYears:!1,showAllYears:!1,allYearsText:"All",startYear:null,showFuture:!0,showPast:!0,tags:[],titleLength:0,dateFormat:"mm/dd/yy",years:[],maxYear:null,minYear:null,defaultThumb:"",append:!0,template:"",loadingMessage:"Loading...",yearTrigger:null,yearSelect:null,activeClass:"active",itemContainer:null,itemTemplate:'<li><img class="thumb" src="{{thumb}}"><span class="date">{{date}}</span><a href="{{url}}" class="title">{{title}}</a></li>',itemLoadingMessage:null,itemNotFoundMessage:"No items found.",onYearChange:function(){},beforeRender:function(){},beforeRenderItems:function(){},itemsComplete:function(){},complete:function(){}},years:null,$widget:null,dataUrl:"",yearsUrl:"",dataResultField:"",yearsResultField:"",dateField:"",_create:function(){this._normalizeOptions()},_init:function(){var b=this,c=this.options,d=this.element;c.append||d.empty(),this.$widget=a(c.loadingMessage||"").appendTo(d),c.showAllYears&&!c.startYear&&(c.fetchAllYears=!0),c.fetchAllYears&&!c.limit?this._getData(-1).done(function(d){var e=b._parseResultsWithYears(d[b.dataResultField]);b.years=a.map(e.years,function(a){return a.value}),b._renderWidget(e,c.showAllYears||!b.years.length?-1:b.years[0])}):this._getYears().done(function(d){if(b.years=a.grep(d[b.yearsResultField],function(a){return b._filterYear(a)}),b.years.length){var e=a.inArray(c.startYear,b.years)>-1?c.startYear:c.showAllYears?-1:b.years[0];b._getData(c.fetchAllYears?-1:e).done(function(a){b._renderWidget(b._parseResultsWithYears(a[b.dataResultField],b.years),e)})}else b._renderWidget(b._parseResultsWithYears([],b.years),-1)})},_setOption:function(a,b){this._super(a,b),this._normalizeOptions()},_normalizeOptions:function(){var a=this.options;a.url=a.url.replace(/\/$/,""),a.years=a.years?[].concat(a.years).sort(function(a,b){return b-a}):[],a.tags=a.tags?[].concat(a.tags):[],"string"==typeof a.startYear&&a.startYear.length&&(a.startYear=parseInt(a.startYear)),null===a.itemLoadingMessage&&(a.itemLoadingMessage=a.loadingMessage),a.append&&(/<|>/.test(a.template)||(a.template="<div>"+a.template+"</div>"),/<|>/.test(a.loadingMessage)||(a.loadingMessage="<div>"+a.loadingMessage+"</div>"))},_buildParams:function(){return{serviceDto:{ViewType:GetViewType(),ViewDate:GetViewDate(),RevisionNumber:GetRevisionNumber(),LanguageId:GetLanguageId(),Signature:GetSignature()}}},_callApi:function(b,c){var d=this.options;return a.ajax({type:"POST",url:d.url+b,data:JSON.stringify(c),contentType:"application/json; charset=utf-8",dataType:"json"})},_getYears:function(){var b=this.options;return this._callApi(this.yearsUrl,a.extend(!0,this._buildParams(),{serviceDto:{TagList:b.tags.length?b.tags:null}}))},_getData:function(b){var c=this.options;return this._callApi(this.dataUrl,a.extend(!0,this._buildParams(),{serviceDto:{ItemCount:c.limit||-1,StartIndex:c.skip,TagList:c.tags.length?c.tags:null,IncludeTags:!0},year:b}))},_filterYear:function(b){var c=this.options;return(!c.maxYear||b<=c.maxYear)&&(!c.minYear||b>=c.minYear)&&(!c.years.length||a.inArray(b,c.years)>-1)},_truncate:function(a,b){return a?!b||a.length<=b?a:a.substring(0,b)+"...":""},_formatDate:function(b){var c=this.options,d=new Date(b);if("string"==typeof c.dateFormat)return a.datepicker.formatDate(c.dateFormat,d);if("object"==typeof c.dateFormat){var e={};for(name in c.dateFormat)e[name]=a.datepicker.formatDate(c.dateFormat[name],d);return e}},_parseResult:function(){return{}},_parseResults:function(b){var c=this;return a.map(b,function(a){return c._parseResult(a)})},_parseResultsWithYears:function(b,c){var d=this,e=this.options,f={},g={years:[],items:[]};return a.isArray(c)||(c=[]),a.each(b,function(b,e){var h=new Date(e[d.dateField]),i=h.getFullYear();if(-1==a.inArray(i,c)){if(!d._filterYear(i))return!0;c.push(i)}i in f||(f[i]=[]);var j=d._parseResult(e);g.items.push(j),f[i].push(j)}),c.sort(function(a,b){return b-a}),a.each(c,function(a,b){g.years.push({year:b,value:b,items:f[b]||[]})}),e.showAllYears&&g.years.length&&g.years.unshift({year:e.allYearsText,value:-1,items:g.items}),g},_renderItems:function(b){var c=this.options,d=this.element;this._trigger("beforeRenderItems",null,{items:b}),b.length?(a(c.itemContainer,d).empty(),a.each(b,function(b,e){a(c.itemContainer,d).append(Mustache.render(c.itemTemplate,e))})):a(c.itemContainer,d).html(c.itemNotFoundMessage),this._trigger("itemsComplete")},_renderWidget:function(b,c){var d=this,e=this.options,f=this.element,g=[];a.each(b.years,function(a,b){b.value==c&&(b.active=!0,g=b.items)}),this._trigger("beforeRender",null,b),this.$widget.remove(),this.$widget=a(Mustache.render(e.template,b)).appendTo(f),e.itemContainer&&e.itemTemplate&&this._renderItems(g),e.yearTrigger&&a(e.yearTrigger,f).each(function(c){var f=b.years[c].value;a(this).data("year",f),a(this).click(function(b){b.preventDefault(),a(this).hasClass(e.activeClass)||d.setYear(f,b)})}),e.yearSelect&&a(e.yearSelect,f).change(function(b){d.setYear(a(this).val(),b)}),this._updateYearControls(c),this._trigger("complete")},_updateYearControls:function(b){var c=this.options,d=this.element;c.yearTrigger&&a(c.yearTrigger,d).each(function(){a(this).toggleClass(c.activeClass,a(this).data("year")==b)}),c.yearSelect&&a(c.yearSelect,d).val(b)},setYear:function(b,c){var d=this,e=this.options,f=this.element;this._trigger("onYearChange",c),c.isDefaultPrevented()||(a.inArray(b,this.years)||(b=e.showAllYears?-1:this.years[0]),this._updateYearControls(b),e.itemContainer&&e.itemTemplate?e.itemLoadingMessage!==!1&&a(e.itemContainer).html(e.itemLoadingMessage):e.loadingMessage!==!1&&(this.$widget.remove(),this.$widget=a(e.loadingMessage).appendTo(f)),this._getData(b).done(function(a){e.itemContainer&&e.itemTemplate?d._renderItems(d._parseResults(a[d.dataResultField])):d._renderWidget(d._parseResultsWithYears(a[d.dataResultField],d.years),b)}))}}),a.widget("q4.events",a.q4.api,{options:{sortAscending:!1},dataUrl:"/Services/EventService.svc/GetEventList",yearsUrl:"/Services/EventService.svc/GetEventYearList",dataResultField:"GetEventListResult",yearsResultField:"GetEventYearListResult",dateField:"StartDate",_normalizeOptions:function(){var a=this.options,b=(new Date).getFullYear();a.showPast&&!a.showFuture?a.maxYear=Math.min(b,a.maxYear||b):a.showFuture&&!a.showPast&&(a.minYear=Math.max(b,a.minYear||b)),this._super()},_buildParams:function(){var b=this.options;return a.extend(this._super(),{eventSelection:b.showFuture&&!b.showPast?1:b.showPast&&!b.showFuture?0:3,includePresentations:!0,includePressReleases:!0,sortOperator:b.sortAscending?0:1})},_parseResult:function(b){var c=this.options,d={title:this._truncate(b.Title,c.titleLength),url:b.LinkToDetailPage,date:this._formatDate(b.StartDate),endDate:this._formatDate(b.EndDate),location:b.Location,body:this._truncate(b.Body,c.bodyLength),docs:a.map(b.Attachments,function(a){return{title:a.Title,url:a.Url,type:a.Type,extension:a.Extension,size:a.Size}})};return b.EventPressRelease.length&&(d.pressRelease={url:b.EventPressRelease[0].LinkToDetailPage}),b.EventPresentation.length&&(d.presentation={url:b.EventPresentation[0].LinkToDetailPage}),b.WebCastLink&&(d.webcast={url:b.WebCastLink}),d}}),a.widget("q4.financials",a.q4.api,{options:{reportTypes:[],docCategories:[],shortTypes:{"Annual Report":"Annual","Supplemental Report":"Supplemental","First Quarter":"Q1","Second Quarter":"Q2","Third Quarter":"Q3","Fourth Quarter":"Q4"}},dataUrl:"/Services/FinancialReportService.svc/GetFinancialReportList",yearsUrl:"/Services/FinancialReportService.svc/GetFinancialReportYearList",dataResultField:"GetFinancialReportListResult",yearsResultField:"GetFinancialReportYearListResult",dateField:"ReportDate",_buildParams:function(){var b=this.options;return a.extend(this._super(),{reportSubTypeList:b.reportTypes})},_parseResult:function(b){var c=this,d=this.options;return{coverUrl:b.CoverImagePath,date:a.datepicker.formatDate(d.dateFormat,new Date(b.ReportDate)),title:b.ReportTitle,year:b.ReportYear,type:b.ReportSubType,shortType:d.shortTypes[b.ReportSubType],docs:a.map(b.Documents,function(a){return{docCategory:a.DocumentCategory,docSize:a.DocumentFileSize,docThumb:a.DocumentThumbnailPath,docTitle:c._truncate(a.DocumentTitle,d.titleLength),docType:a.DocumentFileType,docUrl:a.DocumentPath}})}},_parseResultsWithYears:function(b,c){var d=this.options,e=this._super(b,c);return a.each(e.years,function(b,c){var e=[],f={};a.each(c.items,function(b,c){-1==a.inArray(c.type,e)&&(e.push(c.type),f[c.type]=[]),a.each(c.docs,function(a,b){f[c.type].push(b)})}),c.types=a.map(e,function(a){return{type:a,shortType:d.shortTypes[a],docs:f[a]}})}),e}}),a.widget("q4.presentations",a.q4.api,{options:{},dataUrl:"/Services/PresentationService.svc/GetPresentationList",yearsUrl:"/Services/PresentationService.svc/GetPresentationYearList",dataResultField:"GetPresentationListResult",yearsResultField:"GetPresentationYearListResult",dateField:"PresentationDate",_buildParams:function(){var b=this.options;return a.extend(this._super(),{presentationSelection:b.showFuture&&!b.showPast?0:b.showPast&&!b.showFuture?1:3})},_parseResult:function(a){var b=this.options;return{title:this._truncate(a.Title,b.titleLength),url:a.LinkToDetailPage,date:this._formatDate(a.PresentationDate),tags:a.TagsList,body:this._truncate(a.Body,b.bodyLength),docUrl:a.DocumentPath}}}),a.widget("q4.news",a.q4.api,{options:{category:"00000000-0000-0000-0000-000000000000",loadBody:!0,loadShortBody:!0,bodyLength:0,shortBodyLength:0},dataUrl:"/Services/PressReleaseService.svc/GetPressReleaseList",yearsUrl:"/Services/PressReleaseService.svc/GetPressReleaseYearList",dataResultField:"GetPressReleaseListResult",yearsResultField:"GetPressReleaseYearListResult",dateField:"PressReleaseDate",_buildParams:function(){var b=this.options;return a.extend(this._super(),{pressReleaseSelection:b.showFuture&&!b.showPast?0:b.showPast&&!b.showFuture?1:3,pressReleaseBodyType:b.loadShortBody?b.loadBody?1:3:b.loadBody?2:0,pressReleaseCategoryWorkflowId:b.category})},_parseResult:function(a){var b=this.options;return{title:this._truncate(a.Headline,b.titleLength),url:a.LinkToDetailPage,date:this._formatDate(a.PressReleaseDate),tags:a.TagsList,body:this._truncate(a.Body,b.bodyLength),shortBody:this._truncate(a.ShortBody,b.shortBodyLength),docUrl:a.DocumentPath,docSize:a.DocumentFileSize,docType:a.DocumentFileType,thumb:a.ThumbnailPath||b.defaultThumb}}})}(jQuery);