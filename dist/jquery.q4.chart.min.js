/*! Compiled on 2015-01-13 */
!function(a){a.widget("q4.chart",{options:{url:"",usePublic:!0,apiKey:"",stocks:[],lockStock:!1,showSymbolInLegend:!0,stockLimit:1500,volume:!1,volumeHeight:40,news:!1,newsOnLoad:!1,newsLimit:200,newsLength:75,newsCategory:"00000000-0000-0000-0000-000000000000",newsTags:[],events:!1,eventsOnLoad:!1,eventsLimit:100,stockOpts:{},volumeOpts:{},newsOpts:{},eventsOpts:{},highstock:{chart:{height:400,marginTop:60},legend:{enabled:!0,align:"left",verticalAlign:"top",floating:!0},rangeSelector:{enabled:!0,selected:1},navigator:{height:40},credits:{enabled:!0,text:"Q4 Web Systems",href:"http://www.q4websystems.com"}},highchartsOpts:{global:{useUTC:!1}},onComplete:function(){}},startDate:null,chart:null,_create:function(){var a=this,b=this.options,c=this.element;b.url=b.url.replace(/\/$/,""),Highcharts.setOptions(b.highchartsOpts),this._getStockData(b.stocks[0]).done(function(b){return b.GetStockQuoteHistoricalListResult.length?void a._initChart(b):void c.html("There is currently no stock data, please check back later.")})},_initChart:function(a){var b=this,c=this.options,d=this.element,e=this._parseStockData(a);if(c.highstock.series=this._buildSeries(),c.highstock.series[0].data=e[0],c.volume&&(c.highstock.series[1].data=e[1],c.highstock.yAxis=[c.highstock.yAxis||{},{}]),this.chart=d.highcharts("StockChart",c.highstock).highcharts(),c.volume){var f=this.chart.yAxis[1].getExtremes();this.chart.yAxis[1].setExtremes(0,100*f.max/c.volumeHeight,!0,!1)}c.news&&c.newsOnLoad&&this._getNewsData().done(function(a){b.chart.get("news").setData(b._parseNewsData(a))}),c.events&&c.eventsOnLoad&&this._getEventsData().done(function(a){b.chart.get("events").setData(b._parseEventsData(a))}),this._trigger("onComplete")},_toggleStock:function(a){var b=this,c=this.options,d=c.volume?a._i/2:a._i;if(c.lockStock)return!1;if(a.data.length){if(c.volume){var e=this.chart.get("volume"+d);e.visible?e.hide():e.show()}}else this.chart.showLoading(),this._getStockData(c.stocks[d]).done(function(e){var f=b._parseStockData(e);a.setData(f[0]),c.volume&&b.chart.get("volume"+d).setData(f[1]),b.chart.hideLoading()})},_toggleFlags:function(a){{var b=this;this.options}a.data.length||(this.chart.showLoading(),"news"==a.options.id?this._getNewsData().done(function(a){b.chart.get("news").setData(b._parseNewsData(a)),b.chart.hideLoading()}):this._getEventsData().done(function(a){b.chart.get("events").setData(b._parseEventsData(a)),b.chart.hideLoading()}))},_buildSeries:function(){var b=this,c=b.options,d=[];return a.each(c.stocks,function(e,f){"string"==typeof f&&(f=[f]);var g=f[0].split(":"),h=g[0],i=(g[1],f.length>1&&f[1]?f[1]:f[0]);d.push(a.extend({type:"areaspline",name:i,id:"price"+e,visible:0===e,showInLegend:c.showSymbolInLegend,turboThreshold:0,tooltip:{valueDecimals:2},events:{legendItemClick:function(){b._toggleStock(this)}}},c.stockOpts)),c.volume&&d.push(a.extend({type:"column",name:h+":Volume",id:"volume"+e,turboThreshold:0,showInLegend:!1,yAxis:1},c.volumeOpts))}),c.news&&d.push(a.extend({type:"flags",name:"News",id:"news",onSeries:"price0",shape:"circlepin",width:3,height:3,y:-10,turboThreshold:0,visible:c.newsOnLoad,point:{events:{click:function(){window.location=this.url}}},events:{legendItemClick:function(){b._toggleFlags(this)}}},c.newsOpts)),c.events&&d.push(a.extend({type:"flags",name:"Events",id:"events",onSeries:"price0",shape:"circlepin",width:3,height:3,y:-25,turboThreshold:0,visible:c.eventsOnLoad,point:{events:{click:function(){window.location=this.url}}},events:{legendItemClick:function(){b._toggleFlags(this)}}},c.eventsOpts)),d},_getStockData:function(a){var b=this.options;"string"==typeof a&&(a=[a]);var c=a[0].split(":");return b.usePublic?this._getData("/feed/StockQuote.svc/GetStockQuoteHistoricalList",{exchange:c[0],symbol:c[1]},b.stockLimit):this._getData("/Services/StockQuoteService.svc/GetStockQuoteHistoricalList",{exchange:c[0],symbol:c[1]},b.stockLimit)},_getNewsData:function(){var a=this.options;return a.usePublic?this._getData("/feed/PressRelease.svc/GetPressReleaseList",{pressReleaseDateFilter:3,categoryId:a.categoryId,tagList:a.newsTags.join("|")},a.newsLimit):this._getData("/Services/PressReleaseService.svc/GetPressReleaseList",{serviceDto:{TagList:a.newsTags.join("|")},pressReleaseSelection:3,pressReleaseCategoryWorkflowId:a.categoryId},a.newsLimit)},_getEventsData:function(){var a=this.options;return a.usePublic?this._getData("/feed/Event.svc/GetEventList",{eventDateFilter:3},a.eventsLimit):this._getData("/Services/EventService.svc/GetEventList",{eventSelection:3},a.eventsLimit)},_getData:function(b,c,d){var e,f=this.options;return e=f.usePublic?{type:"GET",url:f.url+b,dataType:"jsonp",contentType:"application/json; charset=utf-8",data:a.extend(!0,{apiKey:f.apiKey,pageSize:d},c)}:{type:"POST",url:f.url+b,dataType:"json",contentType:"application/json; charset=utf-8",data:JSON.stringify(a.extend(!0,{serviceDto:{ViewType:GetViewType(),ViewDate:GetViewDate(),RevisionNumber:GetRevisionNumber(),LanguageId:GetLanguageId(),Signature:GetSignature(),StartIndex:0,ItemCount:d}},c))},a.ajax(e)},_parseStockData:function(b){var c=this,d=(this.options,this.element,[]),e=[];return b.GetStockQuoteHistoricalListResult.length&&null===this.startDate&&(this.startDate=new Date(b.GetStockQuoteHistoricalListResult.slice(-1)[0].HistoricalDate).getTime()),a.each(b.GetStockQuoteHistoricalListResult,function(a,b){var f=b.Last;if(f>0){var g=new Date(b.HistoricalDate).getTime();g>=c.startDate&&(d.push({x:g,y:f,high:b.High,low:b.Low,open:b.Open}),e.push({x:g,y:b.Volume,high:b.High,low:b.Low,open:b.Open}))}}),[d.reverse(),e.reverse()]},_parseNewsData:function(b){var c=this,d=this.options,e=[];return a.each(b.GetPressReleaseListResult,function(a,b){var f=b.Headline.length>d.newsLength+10?b.Headline.substring(0,d.newsLength)+"...":b.Headline,g=d.url+b.LinkToDetailPage,h=new Date(b.PressReleaseDate).getTime();h>=c.startDate&&e.push({x:h,title:" ",text:f,url:g})}),e.reverse()},_parseEventsData:function(b){var c=this,d=this.options,e=[];return a.each(b.GetEventListResult,function(a,b){var f=d.url+b.LinkToDetailPage,g=new Date(b.StartDate).getTime();g>=c.startDate&&e.push({x:g,title:" ",text:b.Title,url:f})}),e.sort(function(a,b){return a.x<b.x?-1:a.x>b.x?1:0})}})}(jQuery);