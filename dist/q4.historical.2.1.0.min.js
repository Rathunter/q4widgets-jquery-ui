/*
Widget:   q4.historical
Version:  2.1.0
Compiled: 2015-03-04
*/
!function(a){a.widget("q4.historical",{options:{exchange:"",symbol:"",dateFormat:"M d, yy",startDate:null,endDate:null,datepicker:"input:first",datepickerOpts:{},updateDatepicker:!0,fetchOnInit:!0,trigger:"",quoteContainer:".quote",quoteTemplate:"",notFoundMessage:"No stock data is available for this date.",loadingClass:""},_init:function(){function b(a){f.addClass(e.loadingClass),d._fetchQuote(a).done(function(a){d._renderQuote(a),f.removeClass(e.loadingClass)})}function c(a){a.preventDefault();var c=h.datepicker("getDate");null!==c&&b(c)}var d=this,e=this.options,f=this.element;if(!e.exchange||!e.symbol){var g=document.location.search.match(/(?:^|&)Indice=([a-z]+):([a-z]+)(?:$|&)/i);if(!g)return void console.log("Error initializing stock historical chart: no exchange/symbol found.");e.exchange=e.exchange||g[1],e.symbol=e.symbol||g[2]}var h=a(e.datepicker,f).val("").datepicker(a.extend({},{minDate:null===e.startDate?null:new Date(e.startDate),maxDate:null===e.endDate?0:new Date(e.endDate),dateFormat:e.dateFormat,changeMonth:!0,changeYear:!0},e.datepickerOpts)),i=a(e.trigger,f);e.trigger&&i.length?i.click(c):h.change(c),e.fetchOnInit&&b(new Date)},_fetchQuote:function(b){var c=this.options;return a.ajax({type:"POST",url:"/services/StockQuoteService.svc/GetStockQuoteHistoricalList",data:JSON.stringify({serviceDto:{RevisionNumber:GetRevisionNumber(),LanguageId:GetLanguageId(),Signature:GetSignature(),ViewType:GetViewType(),ViewDate:GetViewDate(),StartIndex:0,ItemCount:1},exchange:c.exchange,symbol:c.symbol,endDate:"/Date("+b.getTime()+")/"}),contentType:"application/json; charset=utf-8",dataType:"json"})},_renderQuote:function(b){var c=this.options,d=this.element;if(!b.GetStockQuoteHistoricalListResult.length)return a(c.quoteContainer,d).html(c.notFoundMessage),void(c.correctDatepicker&&a(c.datepicker,d).datepicker("setDate",null));b=b.GetStockQuoteHistoricalListResult[0];var e=new Date(b.HistoricalDate);a(c.quoteContainer,d).html(Mustache.render(c.quoteTemplate,{date:a.datepicker.formatDate(c.dateFormat,e),high:b.High,low:b.Low,open:b.Open,close:b.Last,volume:this._addCommas(b.Volume)})),c.updateDatepicker&&a(c.datepicker,d).datepicker("setDate",e)},_addCommas:function(a){for(var b=(""+a).split("."),c=b[0],d=b[1],e=/(\d+)(\d{3})/;e.test(c);)c=c.replace(e,"$1,$2");return c+(d?"."+d:"")}})}(jQuery);