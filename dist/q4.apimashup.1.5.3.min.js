/*
Widget:   q4.apimashup
Version:  1.5.3
Compiled: 2015-06-09
*/
!function(a){a.widget("q4.apiMashup",{options:{contentSources:{},startSource:null,url:"",limit:0,skip:0,fetchAllYears:!1,showAllYears:!1,allYearsText:"All",startYear:null,forceStartYear:!1,showFuture:!0,showPast:!0,tags:[],titleLength:0,dateFormat:"mm/dd/yy",useMoment:!1,years:[],maxYear:null,minYear:null,defaultThumb:"",template:"",append:!0,loadingMessage:"Loading...",yearContainer:null,yearTemplate:null,yearTrigger:null,yearSelect:null,activeClass:"active",itemContainer:null,itemTemplate:"",itemLoadingMessage:null,itemNotFoundMessage:"No items found.",onYearChange:function(){},onContentSourceChange:function(){},beforeRender:function(){},beforeRenderItems:function(){},itemsComplete:function(){},complete:function(){}},years:null,$widget:null,activeSource:null,_init:function(){var b=this.options,c=this.element;this._normalizeOptions(),b.append||c.empty(),this.$widget=a(b.loadingMessage||"").appendTo(c),this._initWidget(b.startSource)},_setOption:function(a,b){this._super(a,b),this._normalizeOptions()},_normalizeOptions:function(){var a=this.options;a.url=a.url.replace(/\/$/,""),a.years=a.years?[].concat(a.years).sort(function(a,b){return b-a}):[],a.tags=a.tags?[].concat(a.tags):[],!a.startSource||a.startSource in a.contentSources||(a.startSource=null),"string"==typeof a.startYear&&a.startYear.length&&(a.startYear=parseInt(a.startYear)),null===a.itemLoadingMessage&&(a.itemLoadingMessage=a.loadingMessage),a.append&&(/<|>/.test(a.template)||(a.template="<div>"+a.template+"</div>"),/<|>/.test(a.loadingMessage)||(a.loadingMessage="<div>"+a.loadingMessage+"</div>")),a.showAllYears&&!a.startYear&&(a.fetchAllYears=!0)},_initWidget:function(b){var c=this,d=this.options;this.activeSource=b;var e=[],f=[];a.each(d.contentSources,function(a){return b&&b!=a?!0:(e.push(a),void f.push(c._getYears(a)))}),a.when.apply(null,f).done(function(){var b=[];a.each(arguments,function(c,d){a.each(d.years,function(c,d){-1==a.inArray(d,b)&&b.push(d)})}),c.years=c._filterYears(b);var f=c._getActiveYear(c.years),g=[];a.each(arguments,function(a,b){g.push(null!==b.items?b.items:c._fetchItems(e[a],d.fetchAllYears?-1:f))}),a.when.apply(null,g).done(function(){var a=Array.prototype.concat.apply([],arguments);a.sort(function(a,b){return a.dateObj-b.dateObj}),d.limit&&(a=a.slice(0,d.limit)),c._renderWidget(a,f)})})},_getYears:function(b){var c=this.options,d=a.Deferred();return c.fetchAllYears&&!c.limit||c.contentSources[b].limit?this._fetchItems(b,-1).done(function(b){var c=[];a.each(b,function(b,d){-1==a.inArray(d.year,c)&&c.push(d.year)}),d.resolve({years:c,items:b})}):this._fetchYears(b).done(function(a){d.resolve({years:a,items:null})}),d},_filterYears:function(b){var c=this.options;return b=a.grep(b,function(b){return(!c.maxYear||b<=c.maxYear)&&(!c.minYear||b>=c.minYear)&&(!c.years.length||a.inArray(b,c.years)>-1)}),c.forceStartYear&&-1==a.inArray(c.startYear,b)&&b.push(c.startYear),b.sort(function(a,b){return b-a}),b},_getActiveYear:function(b){var c=this.options;if(b.length){if(a.inArray(c.startYear,b)>-1)return c.startYear;if(!c.showAllYears)return b[0]}return-1},_buildParams:function(){return{serviceDto:{ViewType:GetViewType(),ViewDate:GetViewDate(),RevisionNumber:GetRevisionNumber(),LanguageId:GetLanguageId(),Signature:GetSignature()}}},_callApi:function(b,c){var d=this.options;return a.ajax({type:"POST",url:d.url+b,data:JSON.stringify(c),contentType:"application/json; charset=utf-8",dataType:"json"})},_fetchYears:function(b){var c=this.options,d=c.contentSources[b],e=this.contentTypes[d.type],f=a.extend({},this.options,e.options,d),g=a.Deferred();return this._callApi(e.yearsUrl,a.extend(!0,this._buildParams(),e.buildParams.call(this,f),{serviceDto:{TagList:c.tags.length?c.tags:null}})).done(function(a){g.resolve(a[e.yearsResultField])}),g},_fetchAllItems:function(b,c){var d=this,e=this.options,f=a.Deferred(),g=[];return a.each(e.contentSources,function(a){return c&&c!=a?!0:void g.push(d._fetchItems(a,b))}),a.when.apply(null,g).done(function(){var a=Array.prototype.concat.apply([],arguments);a.sort(function(a,b){return a.dateObj-b.dateObj}),e.limit&&(a=a.slice(0,e.limit)),f.resolve(a)}),f},_fetchItems:function(b,c){var d=this,e=this.options,f=e.contentSources[b],g=this.contentTypes[f.type],h=a.extend({},this.options,g.options,f),i=a.Deferred();return this._callApi(g.itemsUrl,a.extend(!0,this._buildParams(),g.buildParams.call(this,h),{serviceDto:{ItemCount:f.limit||-1,StartIndex:e.skip,TagList:e.tags.length?e.tags:null,IncludeTags:!0},year:c})).done(function(c){i.resolve(a.map(c[g.itemsResultField],function(a){var c=g.parseItem.call(d,h,a);return c.contentSourceID=b,c}))}),i},_truncate:function(a,b){return a?!b||a.length<=b?a:a.substring(0,b)+"...":""},_formatDate:function(b){var c=this.options,d=new Date(b),e=c.useMoment&&"undefined"!=typeof moment;if("string"==typeof c.dateFormat)return e?moment(d).format(c.dateFormat):a.datepicker.formatDate(c.dateFormat,d);if("object"==typeof c.dateFormat){var f={};for(name in c.dateFormat)f[name]=e?moment(d).format(c.dateFormat[name]):a.datepicker.formatDate(c.dateFormat[name],d);return f}},_buildTemplateData:function(b){var c=this,d=this.options,e={},f={items:[],years:[],contentSources:a.map(d.contentSources,function(a,b){return b})};return a.each(b,function(b,d){return-1==a.inArray(d.year,c.years)?!0:(d.year in e||(e[d.year]=[]),f.items.push(d),void e[d.year].push(d))}),a.each(this.years,function(a,b){f.years.push({year:b,value:b,items:e[b]||[]})}),d.showAllYears&&this.years.length&&f.years.unshift({year:d.allYearsText,value:-1,items:f.items}),f},_renderItems:function(b){var c=this.options,d=this.element;this._trigger("beforeRenderItems",null,{items:b}),b.length?(a(c.itemContainer,d).empty(),a.each(b,function(b,e){var f=c.contentSources[e.contentSourceID].template||c.itemTemplate;a(c.itemContainer,d).append(Mustache.render(f,e))})):a(c.itemContainer,d).html(c.itemNotFoundMessage),this._trigger("itemsComplete")},_renderWidget:function(b,c){var d=this,e=this.options,f=this.element,g=this._buildTemplateData(b),h=[];a.each(g.years,function(a,b){b.value==c&&(b.active=!0,h=b.items)}),this._trigger("beforeRender",null,g),this.$widget.remove(),this.$widget=a(Mustache.render(e.template,g)).appendTo(f),e.yearContainer&&e.yearTemplate&&(a(e.yearContainer,f).empty(),a.each(g.years,function(b,c){a(e.yearContainer,f).append(Mustache.render(e.yearTemplate,c))})),e.itemContainer&&this._renderItems(h),e.yearTrigger&&a(e.yearTrigger,f).each(function(b){var c=g.years[b].value;a(this).data("year",c),a(this).click(function(b){b.preventDefault(),a(this).hasClass(e.activeClass)||d.setYear(c,b)})}),e.yearSelect&&a(e.yearSelect,f).change(function(b){d.setYear(a(this).val(),b)}),this._updateYearControls(c),this._trigger("complete")},_updateYearControls:function(b){var c=this.options,d=this.element;c.yearTrigger&&a(c.yearTrigger,d).each(function(){a(this).toggleClass(c.activeClass,a(this).data("year")==b)}),c.yearSelect&&a(c.yearSelect,d).val(b)},setYear:function(b,c){var d=this,e=this.options,f=this.element;this._trigger("onYearChange",c)&&(b=parseInt(b),-1==a.inArray(b,this.years)&&(b=e.showAllYears?-1:this.years[0]),this._updateYearControls(b),e.itemContainer?e.itemLoadingMessage!==!1&&a(e.itemContainer,f).html(e.itemLoadingMessage):e.loadingMessage!==!1&&(this.$widget.remove(),this.$widget=a(e.loadingMessage).appendTo(f)),this._fetchAllItems(b,this.activeSource).done(function(a){e.itemContainer?d._renderItems(a):d._renderWidget(a,b)}))},setContentSource:function(a,b){this.options,this.element;this._trigger("onContentSourceChange",b)&&(this.activeSource=a,this._initWidget(a))},contentTypes:{downloads:{options:{downloadType:"",template:""},itemsUrl:"/Services/ContentAssetService.svc/GetContentAssetList",yearsUrl:"/Services/ContentAssetService.svc/GetContentAssetYearList",itemsResultField:"GetContentAssetListResult",yearsResultField:"GetContentAssetYearListResult",buildParams:function(a){return{assetType:a.downloadType}},parseItem:function(a,b){return{title:this._truncate(b.Title,a.titleLength),url:b.FilePath,dateObj:new Date(b.ContentAssetDate),year:new Date(b.ContentAssetDate).getFullYear(),date:this._formatDate(b.ContentAssetDate),type:b.Type,fileType:b.FileType,size:b.FileSize,icon:b.IconPath,thumb:b.ThumbnailPath,tags:b.TagsList,description:this._truncate(b.Description,a.bodyLength)}}},events:{options:{template:""},itemsUrl:"/Services/EventService.svc/GetEventList",yearsUrl:"/Services/EventService.svc/GetEventYearList",itemsResultField:"GetEventListResult",yearsResultField:"GetEventYearListResult",buildParams:function(a){return{eventSelection:a.showFuture&&!a.showPast?1:a.showPast&&!a.showFuture?0:3,includePresentations:!0,includePressReleases:!0,sortOperator:a.sortAscending?0:1}},parseItem:function(b,c){var d={title:this._truncate(c.Title,b.titleLength),url:c.LinkToDetailPage,dateObj:new Date(c.StartDate),year:new Date(c.StartDate).getFullYear(),date:this._formatDate(c.StartDate),endDate:this._formatDate(c.EndDate),timeZone:c.TimeZone,location:c.Location,tags:c.TagsList,body:this._truncate(c.Body,b.bodyLength),docs:a.map(c.Attachments,function(a){return{title:a.Title,url:a.Url,type:a.Type,extension:a.Extension,size:a.Size}})};return c.EventPressRelease.length&&(d.pressRelease={url:c.EventPressRelease[0].LinkToDetailPage}),c.EventPresentation.length&&(d.presentation={url:c.EventPresentation[0].LinkToDetailPage}),c.WebCastLink&&(d.webcast={url:c.WebCastLink}),d}},financials:{options:{reportTypes:[],docCategories:[],shortTypes:{"Annual Report":"Annual","Supplemental Report":"Supplemental","First Quarter":"Q1","Second Quarter":"Q2","Third Quarter":"Q3","Fourth Quarter":"Q4"},template:""},itemsUrl:"/Services/FinancialReportService.svc/GetFinancialReportList",yearsUrl:"/Services/FinancialReportService.svc/GetFinancialReportYearList",itemsResultField:"GetFinancialReportListResult",yearsResultField:"GetFinancialReportYearListResult",buildParams:function(a){return{reportSubTypeList:a.reportTypes}},parseItem:function(b,c){return{coverUrl:c.CoverImagePath,title:c.ReportTitle,fiscalYear:c.ReportYear,year:new Date(c.ReportDate).getFullYear(),date:this._formatDate(c.ReportDate),type:c.ReportSubType,shortType:b.shortTypes[c.ReportSubType],docs:a.map(c.Documents,function(a){return{docCategory:a.DocumentCategory,docSize:a.DocumentFileSize,docThumb:a.ThumbnailPath,docTitle:_._truncate(a.DocumentTitle,b.titleLength),docType:a.DocumentFileType,docUrl:a.DocumentPath}})}}},presentations:{options:{template:""},itemsUrl:"/Services/PresentationService.svc/GetPresentationList",yearsUrl:"/Services/PresentationService.svc/GetPresentationYearList",itemsResultField:"GetPresentationListResult",yearsResultField:"GetPresentationYearListResult",buildParams:function(a){return{presentationSelection:a.showFuture&&!a.showPast?0:a.showPast&&!a.showFuture?1:3}},parseItem:function(a,b){return{title:this._truncate(b.Title,a.titleLength),url:b.LinkToDetailPage,dateObj:new Date(b.PresentationDate),year:new Date(b.PresentationDate).getFullYear(),date:this._formatDate(b.PresentationDate),tags:b.TagsList,body:this._truncate(b.Body,a.bodyLength),docUrl:b.DocumentPath,docSize:b.DocumentFileSize,docType:b.DocumentFileType}}},news:{options:{category:"00000000-0000-0000-0000-000000000000",loadBody:!0,loadShortBody:!0,bodyLength:0,shortBodyLength:0,template:""},itemsUrl:"/Services/PressReleaseService.svc/GetPressReleaseList",yearsUrl:"/Services/PressReleaseService.svc/GetPressReleaseYearList",itemsResultField:"GetPressReleaseListResult",yearsResultField:"GetPressReleaseYearListResult",buildParams:function(a){return{pressReleaseSelection:a.showFuture&&!a.showPast?0:a.showPast&&!a.showFuture?1:3,pressReleaseBodyType:a.loadShortBody?a.loadBody?1:3:a.loadBody?2:0,pressReleaseCategoryWorkflowId:a.category}},parseItem:function(a,b){return{title:this._truncate(b.Headline,a.titleLength),url:b.LinkToDetailPage,dateObj:new Date(b.PressReleaseDate),year:new Date(b.PressReleaseDate).getFullYear(),date:this._formatDate(b.PressReleaseDate),tags:b.TagsList,body:this._truncate(b.Body,a.bodyLength),shortBody:this._truncate(b.ShortBody,a.shortBodyLength),docUrl:b.DocumentPath,docSize:b.DocumentFileSize,docType:b.DocumentFileType,thumb:b.ThumbnailPath||a.defaultThumb}}}}})}(jQuery);