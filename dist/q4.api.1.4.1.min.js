/*
Widget:   q4.api
Version:  1.4.1
Compiled: 2015-04-29
*/
!function(a){a.widget("q4.api",{options:{url:"",limit:0,skip:0,fetchAllYears:!1,showAllYears:!1,allYearsText:"All",startYear:null,forceStartYear:!1,showFuture:!0,showPast:!0,tags:[],titleLength:0,dateFormat:"mm/dd/yy",useMoment:!1,years:[],maxYear:null,minYear:null,defaultThumb:"",template:"",append:!0,loadingMessage:"Loading...",yearContainer:null,yearTemplate:null,yearTrigger:null,yearSelect:null,activeClass:"active",itemContainer:null,itemTemplate:"",itemLoadingMessage:null,itemNotFoundMessage:"No items found.",onYearChange:function(){},beforeRender:function(){},beforeRenderItems:function(){},itemsComplete:function(){},complete:function(){}},years:null,$widget:null,itemsUrl:"",yearsUrl:"",itemsResultField:"",yearsResultField:"",_init:function(){var b=this,c=this.options,d=this.element;this._normalizeOptions(),c.append||d.empty(),this.$widget=a(c.loadingMessage||"").appendTo(d),this._getYears().done(function(a,d){b.years=b._filterYears(a);var e=b._getActiveYear(b.years);void 0!==d?b._renderWidget(d,e):b._fetchItems(c.fetchAllYears?-1:e).done(function(a){b._renderWidget(a,e)})})},_getYears:function(){var b=this.options;if(b.fetchAllYears&&!b.limit){var c=a.Deferred();return this._fetchItems(-1).done(function(b){var d=[];a.each(b,function(b,c){-1==a.inArray(c.year,d)&&d.push(c.year)}),c.resolve(d,b)}),c}return this._fetchYears()},_filterYears:function(b){var c=this.options;return b=a.grep(b,function(b){return(!c.maxYear||b<=c.maxYear)&&(!c.minYear||b>=c.minYear)&&(!c.years.length||a.inArray(b,c.years)>-1)}),c.forceStartYear&&-1==a.inArray(c.startYear,b)&&b.push(c.startYear),b.sort(function(a,b){return b-a}),b},_getActiveYear:function(b){var c=this.options;if(b.length){if(a.inArray(c.startYear,b)>-1)return c.startYear;if(!c.showAllYears)return b[0]}return-1},_setOption:function(a,b){this._super(a,b),this._normalizeOptions()},_normalizeOptions:function(){var a=this.options;a.url=a.url.replace(/\/$/,""),a.years=a.years?[].concat(a.years).sort(function(a,b){return b-a}):[],a.tags=a.tags?[].concat(a.tags):[],"string"==typeof a.startYear&&a.startYear.length&&(a.startYear=parseInt(a.startYear)),null===a.itemLoadingMessage&&(a.itemLoadingMessage=a.loadingMessage),a.append&&(/<|>/.test(a.template)||(a.template="<div>"+a.template+"</div>"),/<|>/.test(a.loadingMessage)||(a.loadingMessage="<div>"+a.loadingMessage+"</div>"));var b=(new Date).getFullYear();a.showPast&&!a.showFuture?a.maxYear=Math.min(b,a.maxYear||b):a.showFuture&&!a.showPast&&(a.minYear=Math.max(b,a.minYear||b)),a.showAllYears&&!a.startYear&&(a.fetchAllYears=!0)},_buildParams:function(){return{serviceDto:{ViewType:GetViewType(),ViewDate:GetViewDate(),RevisionNumber:GetRevisionNumber(),LanguageId:GetLanguageId(),Signature:GetSignature()}}},_callApi:function(b,c){var d=this.options;return a.ajax({type:"POST",url:d.url+b,data:JSON.stringify(c),contentType:"application/json; charset=utf-8",dataType:"json"})},_fetchYears:function(){var b=this,c=this.options,d=a.Deferred();return this._callApi(this.yearsUrl,a.extend(!0,this._buildParams(),{serviceDto:{TagList:c.tags.length?c.tags:null}})).done(function(a){d.resolve(a[b.yearsResultField])}),d},_fetchItems:function(b){var c=this,d=this.options,e=a.Deferred();return this._callApi(this.itemsUrl,a.extend(!0,this._buildParams(),{serviceDto:{ItemCount:d.limit||-1,StartIndex:d.skip,TagList:d.tags.length?d.tags:null,IncludeTags:!0},year:b})).done(function(b){e.resolve(a.map(b[c.itemsResultField],function(a){return c._parseItem(a)}))}),e},_truncate:function(a,b){return a?!b||a.length<=b?a:a.substring(0,b)+"...":""},_formatDate:function(b){var c=this.options,d=new Date(b),e=c.useMoment&&"undefined"!=typeof moment;if("string"==typeof c.dateFormat)return e?moment(d).format(c.dateFormat):a.datepicker.formatDate(c.dateFormat,d);if("object"==typeof c.dateFormat){var f={};for(name in c.dateFormat)f[name]=e?moment(d).format(c.dateFormat[name]):a.datepicker.formatDate(c.dateFormat[name],d);return f}},_parseItem:function(){return{}},_buildTemplateData:function(b){var c=this,d=this.options,e={},f={items:[],years:[]};return a.each(b,function(b,d){return-1==a.inArray(d.year,c.years)?!0:(d.year in e||(e[d.year]=[]),f.items.push(d),void e[d.year].push(d))}),a.each(this.years,function(a,b){f.years.push({year:b,value:b,items:e[b]||[]})}),d.showAllYears&&this.years.length&&f.years.unshift({year:d.allYearsText,value:-1,items:f.items}),f},_renderItems:function(b){var c=this.options,d=this.element;this._trigger("beforeRenderItems",null,{items:b}),b.length?(a(c.itemContainer,d).empty(),a.each(b,function(b,e){a(c.itemContainer,d).append(Mustache.render(c.itemTemplate,e))})):a(c.itemContainer,d).html(c.itemNotFoundMessage),this._trigger("itemsComplete")},_renderWidget:function(b,c){var d=this,e=this.options,f=this.element,g=this._buildTemplateData(b),h=[];a.each(g.years,function(a,b){b.value==c&&(b.active=!0,h=b.items)}),this._trigger("beforeRender",null,g),this.$widget.remove(),this.$widget=a(Mustache.render(e.template,g)).appendTo(f),e.yearContainer&&e.yearTemplate&&(a(e.yearContainer,f).empty(),a.each(g.years,function(b,c){a(e.yearContainer,f).append(Mustache.render(e.yearTemplate,c))})),e.itemContainer&&e.itemTemplate&&this._renderItems(h),e.yearTrigger&&a(e.yearTrigger,f).each(function(b){var c=g.years[b].value;a(this).data("year",c),a(this).click(function(b){b.preventDefault(),a(this).hasClass(e.activeClass)||d.setYear(c,b)})}),e.yearSelect&&a(e.yearSelect,f).change(function(b){d.setYear(a(this).val(),b)}),this._updateYearControls(c),this._trigger("complete")},_updateYearControls:function(b){var c=this.options,d=this.element;c.yearTrigger&&a(c.yearTrigger,d).each(function(){a(this).toggleClass(c.activeClass,a(this).data("year")==b)}),c.yearSelect&&a(c.yearSelect,d).val(b)},setYear:function(b,c){var d=this,e=this.options,f=this.element;this._trigger("onYearChange",c)&&(-1==a.inArray(b,this.years)&&(b=e.showAllYears?-1:this.years[0]),this._updateYearControls(b),e.itemContainer&&e.itemTemplate?e.itemLoadingMessage!==!1&&a(e.itemContainer,f).html(e.itemLoadingMessage):e.loadingMessage!==!1&&(this.$widget.remove(),this.$widget=a(e.loadingMessage).appendTo(f)),this._fetchItems(b).done(function(a){e.itemContainer&&e.itemTemplate?d._renderItems(a):d._renderWidget(a,b)}))}}),a.widget("q4.events",a.q4.api,{options:{sortAscending:!1,template:""},itemsUrl:"/Services/EventService.svc/GetEventList",yearsUrl:"/Services/EventService.svc/GetEventYearList",itemsResultField:"GetEventListResult",yearsResultField:"GetEventYearListResult",_buildParams:function(){var b=this.options;return a.extend(this._super(),{eventSelection:b.showFuture&&!b.showPast?1:b.showPast&&!b.showFuture?0:3,includePresentations:!0,includePressReleases:!0,sortOperator:b.sortAscending?0:1})},_parseItem:function(b){var c=this.options,d={title:this._truncate(b.Title,c.titleLength),url:b.LinkToDetailPage,year:new Date(b.StartDate).getFullYear(),date:this._formatDate(b.StartDate),endDate:this._formatDate(b.EndDate),timeZone:b.TimeZone,location:b.Location,tags:b.TagsList,body:this._truncate(b.Body,c.bodyLength),docs:a.map(b.Attachments,function(a){return{title:a.Title,url:a.Url,type:a.Type,extension:a.Extension,size:a.Size}})};return b.EventPressRelease.length&&(d.pressRelease={url:b.EventPressRelease[0].LinkToDetailPage}),b.EventPresentation.length&&(d.presentation={url:b.EventPresentation[0].LinkToDetailPage}),b.WebCastLink&&(d.webcast={url:b.WebCastLink}),d}}),a.widget("q4.downloads",a.q4.api,{options:{template:""},itemsUrl:"/Services/ContentAssetService.svc/GetContentAssetList",yearsUrl:"/Services/ContentAssetService.svc/GetContentAssetYearList",itemsResultField:"GetContentAssetListResult",yearsResultField:"GetContentAssetYearListResult",_buildParams:function(){var b=this.options;return a.extend(this._super(),{assetType:b.downloadType})},_parseItem:function(a){var b=this.options;return{title:this._truncate(a.Title,b.titleLength),url:a.FilePath,dateObj:new Date(a.ContentAssetDate),year:new Date(a.ContentAssetDate).getFullYear(),date:this._formatDate(a.ContentAssetDate),type:a.Type,icon:a.IconPath,thumb:a.ThumbnailPath,tags:a.TagsList,description:this._truncate(a.Description,b.bodyLength)}}}),a.widget("q4.financials",a.q4.api,{options:{reportTypes:[],docCategories:[],shortTypes:{"Annual Report":"Annual","Supplemental Report":"Supplemental","First Quarter":"Q1","Second Quarter":"Q2","Third Quarter":"Q3","Fourth Quarter":"Q4"},template:""},itemsUrl:"/Services/FinancialReportService.svc/GetFinancialReportList",yearsUrl:"/Services/FinancialReportService.svc/GetFinancialReportYearList",itemsResultField:"GetFinancialReportListResult",yearsResultField:"GetFinancialReportYearListResult",_buildParams:function(){var b=this.options;return a.extend(this._super(),{reportSubTypeList:b.reportTypes})},_parseItem:function(b){var c=this,d=this.options;return{coverUrl:b.CoverImagePath,title:b.ReportTitle,fiscalYear:b.ReportYear,year:new Date(b.ReportDate).getFullYear(),date:this._formatDate(b.ReportDate),type:b.ReportSubType,shortType:d.shortTypes[b.ReportSubType],docs:a.map(b.Documents,function(a){return{docCategory:a.DocumentCategory,docSize:a.DocumentFileSize,docThumb:a.DocumentThumbnailPath,docTitle:c._truncate(a.DocumentTitle,d.titleLength),docType:a.DocumentFileType,docUrl:a.DocumentPath}})}},_sortItemsByType:function(b){var c=this.options,d=[],e={};return a.each(b,function(b,c){-1==a.inArray(c.type,d)&&(d.push(c.type),e[c.type]=[]),a.each(c.docs,function(a,b){e[c.type].push(b)})}),a.map(d,function(a){return{type:a,shortType:c.shortTypes[a],items:e[a]}})},_buildTemplateData:function(b){var c=this,d=this._super(b);return d.types=this._sortItemsByType(d.items),a.each(d.years,function(a,b){b.types=c._sortItemsByType(b.items)}),d}}),a.widget("q4.presentations",a.q4.api,{options:{template:""},itemsUrl:"/Services/PresentationService.svc/GetPresentationList",yearsUrl:"/Services/PresentationService.svc/GetPresentationYearList",itemsResultField:"GetPresentationListResult",yearsResultField:"GetPresentationYearListResult",_buildParams:function(){var b=this.options;return a.extend(this._super(),{presentationSelection:b.showFuture&&!b.showPast?0:b.showPast&&!b.showFuture?1:3})},_parseItem:function(a){var b=this.options;return{title:this._truncate(a.Title,b.titleLength),url:a.LinkToDetailPage,year:new Date(a.PresentationDate).getFullYear(),date:this._formatDate(a.PresentationDate),tags:a.TagsList,body:this._truncate(a.Body,b.bodyLength),docUrl:a.DocumentPath}}}),a.widget("q4.news",a.q4.api,{options:{category:"00000000-0000-0000-0000-000000000000",loadBody:!0,loadShortBody:!0,bodyLength:0,shortBodyLength:0,template:""},itemsUrl:"/Services/PressReleaseService.svc/GetPressReleaseList",yearsUrl:"/Services/PressReleaseService.svc/GetPressReleaseYearList",itemsResultField:"GetPressReleaseListResult",yearsResultField:"GetPressReleaseYearListResult",_buildParams:function(){var b=this.options;return a.extend(this._super(),{pressReleaseSelection:b.showFuture&&!b.showPast?0:b.showPast&&!b.showFuture?1:3,pressReleaseBodyType:b.loadShortBody?b.loadBody?1:3:b.loadBody?2:0,pressReleaseCategoryWorkflowId:b.category})},_parseItem:function(a){var b=this.options;return{title:this._truncate(a.Headline,b.titleLength),url:a.LinkToDetailPage,year:new Date(a.PressReleaseDate).getFullYear(),date:this._formatDate(a.PressReleaseDate),tags:a.TagsList,body:this._truncate(a.Body,b.bodyLength),shortBody:this._truncate(a.ShortBody,b.shortBodyLength),docUrl:a.DocumentPath,docSize:a.DocumentFileSize,docType:a.DocumentFileType,thumb:a.ThumbnailPath||b.defaultThumb}}}),a.widget("q4.sec",a.q4.api,{options:{exchange:"",symbol:"",filingTypes:[],excludeNoDocuments:!1,template:""},itemsUrl:"/Services/SECFilingService.svc/GetEdgarFilingList",yearsUrl:"/Services/SECFilingService.svc/GetEdgarFilingYearList",itemsResultField:"GetEdgarFilingListResult",yearsResultField:"GetEdgarFilingYearListResult",_buildParams:function(){var b=this.options;return a.extend(this._super(),{exchange:b.exchange,symbol:b.symbol,formGroupIdList:b.filingTypes.join(",")})},_parseItem:function(a){var b=this.options;return{title:this._truncate(a.FilingDescription,b.titleLength),url:a.LinkToDetailPage,year:new Date(a.FilingDate).getFullYear(),date:this._formatDate(a.FilingDate),agent:a.FilingAgentName}}})}(jQuery);