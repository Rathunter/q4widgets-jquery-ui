/*
Widget:   q4.calculator
Version:  1.0.0
Compiled: 2015-07-06
*/
!function(a){a.widget("q4.calculator",{options:{url:"",usePublic:!1,apiKey:"",exchange:"",symbol:"",dateFormat:"M d, yy",minDate:null,maxDate:null,startDatepicker:".startDate",endDatepicker:".endDate",datepickerOpts:{},amountInput:".amount",defaultAmount:1e4,trigger:".calculate",loadingClass:"",infoContainer:".info",infoTemplate:"",chartContainer:".chart",highstockOpts:{}},_init:function(){var b=this,c=this.options,d=this.element,e=a.extend({},{minDate:null===c.minDate?null:new Date(c.minDate),maxDate:null===c.maxDate?0:new Date(c.maxDate),dateFormat:c.dateFormat,changeMonth:!0,changeYear:!0},c.datepickerOpts),f=a(c.startDatepicker,d).val("").datepicker(e),g=a(c.endDatepicker,d).val("").datepicker(e);a(c.trigger,d).click(function(e){e.preventDefault();var h=Number(a(c.amountInput,d).val())||c.defaultAmount;if(h){d.addClass(c.loadingClass),a(c.infoContainer,d).empty(),a(c.chartContainer,d).empty();var i=f.datepicker("getDate"),j=g.datepicker("getDate");b._fetchStockData(i,j).done(function(a){b._calculate(h,i,j,a.GetStockQuoteHistoricalListResult.reverse()),d.removeClass(c.loadingClass)})}})},_fetchStockData:function(b,c){var d=this.options;return d.usePublic?a.ajax({type:"GET",url:d.url+"/feed/StockQuote.svc/GetStockQuoteHistoricalList",data:{apiKey:d.apiKey,exchange:d.exchange,symbol:d.symbol,startDate:a.datepicker.formatDate("M-dd-yy",b),endDate:a.datepicker.formatDate("M-dd-yy",c)},contentType:"application/json; charset=utf-8",dataType:"jsonp"}):a.ajax({type:"POST",url:d.url+"/Services/StockQuoteService.svc/GetStockQuoteHistoricalList",dataType:"json",contentType:"application/json; charset=utf-8",data:JSON.stringify({exchange:d.exchange,symbol:d.symbol,startDate:"/Date("+b.getTime()+")/",endDate:"/Date("+c.getTime()+")/",serviceDto:{ViewType:GetViewType(),ViewDate:GetViewDate(),RevisionNumber:GetRevisionNumber(),LanguageId:GetLanguageId(),Signature:GetSignature()}})})},_addCommas:function(a){for(var b=(""+a).split("."),c=b[0],d=b[1],e=/(\d+)(\d{3})/;e.test(c);)c=c.replace(e,"$1,$2");return c+(d?"."+d:"")},_calculate:function(b,c,d,e){var f=this.options,g=this.element,h=e[0].Last,i=e.slice(-1)[0].Last,j=b/h,k=i*j,l=(d-c)/1e3/60/60/24/365.24,m=Math.pow(k/b,1/l)-1,n=a.map(e,function(a){return[[new Date(a.HistoricalDate).getTime(),a.Last*j]]});a(f.infoContainer,g).html(Mustache.render(f.infoTemplate,{startDate:a.datepicker.formatDate(f.dateFormat,c),endDate:a.datepicker.formatDate(f.dateFormat,d),startPrice:h.toFixed(2),endPrice:i.toFixed(2),totalReturn:this._addCommas(((i-h)/h*100).toFixed(2)),cagr:(100*m).toFixed(2),shares:this._addCommas(j),startAmount:this._addCommas(b.toFixed(2)),endAmount:this._addCommas(k.toFixed(2)),years:Math.round(10*l)/10})),a(f.chartContainer,g).highcharts("StockChart",a.extend(!0,{navigator:{enabled:!1},rangeSelector:{enabled:!1,selected:5},series:[{name:f.symbol,data:n,tooltip:{valueDecimals:2}}]},f.highstockOpts))}})}(jQuery);