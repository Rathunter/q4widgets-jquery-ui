/*
Widget:   q4.api
Version:  1.1.0
Compiled: 2015-02-02
*/
!function(a){a.widget("q4.api",{options:{url:"",limit:0,skip:0,fetchAllYears:!1,showAllYears:!1,allYearsText:"All",startYear:null,forceStartYear:!1,showFuture:!0,showPast:!0,tags:[],titleLength:0,dateFormat:"mm/dd/yy",useMoment:!1,years:[],maxYear:null,minYear:null,defaultThumb:"",append:!0,template:"",loadingMessage:"Loading...",yearTrigger:null,yearSelect:null,activeClass:"active",itemContainer:null,itemTemplate:"",itemLoadingMessage:null,itemNotFoundMessage:"No items found.",onYearChange:function(){},beforeRender:function(){},beforeRenderItems:function(){},itemsComplete:function(){},complete:function(){}},years:null,$widget:null,dataUrl:"",yearsUrl:"",itemsResultField:"",yearsResultField:"",dateField:"",_create:function(){this._normalizeOptions()},_init:function(){var b=this,c=this.options,d=this.element,e=a.Deferred(),f=a.Deferred();c.append||d.empty(),this.$widget=a(c.loadingMessage||"").appendTo(d),c.showAllYears&&!c.startYear&&(c.fetchAllYears=!0),c.fetchAllYears&&!c.limit?this._getItems(-1).done(function(c){var d=c[b.itemsResultField];e.resolve(d),f.resolve(a.map(d,function(a){return new Date(a[b.dateField]).getFullYear()}))}):this._getYears().done(function(a){f.resolve(a[b.yearsResultField])}),f.done(function(d){b.years=a.grep(d,function(b){return(!c.maxYear||b<=c.maxYear)&&(!c.minYear||b>=c.minYear)&&(!c.years.length||a.inArray(b,c.years)>-1)}),c.forceStartYear&&-1==a.inArray(c.startYear,b.years)&&b.years.push(c.startYear),b.years.sort(function(a,b){return b-a});var f=-1;b.years.length&&(a.inArray(c.startYear,b.years)>-1?f=c.startYear:c.showAllYears||(f=b.years[0])),e.isResolved()||b._getItems(c.fetchAllYears?-1:f).done(function(a){e.resolve(a[b.itemsResultField])}),e.done(function(a){b._renderWidget(a,f)})})},_setOption:function(a,b){this._super(a,b),this._normalizeOptions()},_normalizeOptions:function(){var a=this.options;a.url=a.url.replace(/\/$/,""),a.years=a.years?[].concat(a.years).sort(function(a,b){return b-a}):[],a.tags=a.tags?[].concat(a.tags):[],"string"==typeof a.startYear&&a.startYear.length&&(a.startYear=parseInt(a.startYear)),null===a.itemLoadingMessage&&(a.itemLoadingMessage=a.loadingMessage),a.append&&(/<|>/.test(a.template)||(a.template="<div>"+a.template+"</div>"),/<|>/.test(a.loadingMessage)||(a.loadingMessage="<div>"+a.loadingMessage+"</div>"))},_buildParams:function(){return{serviceDto:{ViewType:GetViewType(),ViewDate:GetViewDate(),RevisionNumber:GetRevisionNumber(),LanguageId:GetLanguageId(),Signature:GetSignature()}}},_callApi:function(b,c){var d=this.options;return a.ajax({type:"POST",url:d.url+b,data:JSON.stringify(c),contentType:"application/json; charset=utf-8",dataType:"json"})},_getYears:function(){var b=this.options;return this._callApi(this.yearsUrl,a.extend(!0,this._buildParams(),{serviceDto:{TagList:b.tags.length?b.tags:null}}))},_getItems:function(b){var c=this.options;return this._callApi(this.dataUrl,a.extend(!0,this._buildParams(),{serviceDto:{ItemCount:c.limit||-1,StartIndex:c.skip,TagList:c.tags.length?c.tags:null,IncludeTags:!0},year:b}))},_truncate:function(a,b){return a?!b||a.length<=b?a:a.substring(0,b)+"...":""},_formatDate:function(b){var c=this.options,d=new Date(b),e=c.useMoment&&"undefined"!=typeof moment;if("string"==typeof c.dateFormat)return e?moment(d).format(c.dateFormat):a.datepicker.formatDate(c.dateFormat,d);if("object"==typeof c.dateFormat){var f={};for(name in c.dateFormat)f[name]=e?moment(d).format(c.dateFormat[name]):a.datepicker.formatDate(c.dateFormat[name],d);return f}},_parseItem:function(){return{}},_parseItems:function(b){var c=this;return a.map(b,function(a){return c._parseItem(a)})},_buildTemplateData:function(b){var c=this,d=this.options,e={},f={items:[],years:[]};return a.each(b,function(b,d){var g=new Date(d[c.dateField]),h=g.getFullYear();if(-1==a.inArray(h,c.years))return!0;h in e||(e[h]=[]);var i=c._parseItem(d);f.items.push(i),e[h].push(i)}),a.each(this.years,function(a,b){f.years.push({year:b,value:b,items:e[b]||[]})}),d.showAllYears&&this.years.length&&f.years.unshift({year:d.allYearsText,value:-1,items:f.items}),f},_renderItems:function(b){var c=this.options,d=this.element;this._trigger("beforeRenderItems",null,{items:b}),b.length?(a(c.itemContainer,d).empty(),a.each(b,function(b,e){a(c.itemContainer,d).append(Mustache.render(c.itemTemplate,e))})):a(c.itemContainer,d).html(c.itemNotFoundMessage),this._trigger("itemsComplete")},_renderWidget:function(b,c){var d=this,e=this.options,f=this.element,g=this._buildTemplateData(b),h=[];a.each(g.years,function(a,b){b.value==c&&(b.active=!0,h=b.items)}),this._trigger("beforeRender",null,g),this.$widget.remove(),this.$widget=a(Mustache.render(e.template,g)).appendTo(f),e.itemContainer&&e.itemTemplate&&this._renderItems(h),e.yearTrigger&&a(e.yearTrigger,f).each(function(b){var c=g.years[b].value;a(this).data("year",c),a(this).click(function(b){b.preventDefault(),a(this).hasClass(e.activeClass)||d.setYear(c,b)})}),e.yearSelect&&a(e.yearSelect,f).change(function(b){d.setYear(a(this).val(),b)}),this._updateYearControls(c),this._trigger("complete")},_updateYearControls:function(b){var c=this.options,d=this.element;c.yearTrigger&&a(c.yearTrigger,d).each(function(){a(this).toggleClass(c.activeClass,a(this).data("year")==b)}),c.yearSelect&&a(c.yearSelect,d).val(b)},setYear:function(b,c){var d=this,e=this.options,f=this.element;this._trigger("onYearChange",c)&&(a.inArray(b,this.years)||(b=e.showAllYears?-1:this.years[0]),this._updateYearControls(b),e.itemContainer&&e.itemTemplate?e.itemLoadingMessage!==!1&&a(e.itemContainer,f).html(e.itemLoadingMessage):e.loadingMessage!==!1&&(this.$widget.remove(),this.$widget=a(e.loadingMessage).appendTo(f)),this._getItems(b).done(function(a){e.itemContainer&&e.itemTemplate?d._renderItems(d._parseItems(a[d.itemsResultField])):d._renderWidget(a[d.itemsResultField],b)}))}}),a.widget("q4.events",a.q4.api,{options:{sortAscending:!1},dataUrl:"/Services/EventService.svc/GetEventList",yearsUrl:"/Services/EventService.svc/GetEventYearList",itemsResultField:"GetEventListResult",yearsResultField:"GetEventYearListResult",dateField:"StartDate",_normalizeOptions:function(){var a=this.options,b=(new Date).getFullYear();a.showPast&&!a.showFuture?a.maxYear=Math.min(b,a.maxYear||b):a.showFuture&&!a.showPast&&(a.minYear=Math.max(b,a.minYear||b)),this._super()},_buildParams:function(){var b=this.options;return a.extend(this._super(),{eventSelection:b.showFuture&&!b.showPast?1:b.showPast&&!b.showFuture?0:3,includePresentations:!0,includePressReleases:!0,sortOperator:b.sortAscending?0:1})},_parseItem:function(b){var c=this.options,d={title:this._truncate(b.Title,c.titleLength),url:b.LinkToDetailPage,date:this._formatDate(b.StartDate),endDate:this._formatDate(b.EndDate),timeZone:b.TimeZone,location:b.Location,body:this._truncate(b.Body,c.bodyLength),docs:a.map(b.Attachments,function(a){return{title:a.Title,url:a.Url,type:a.Type,extension:a.Extension,size:a.Size}})};return b.EventPressRelease.length&&(d.pressRelease={url:b.EventPressRelease[0].LinkToDetailPage}),b.EventPresentation.length&&(d.presentation={url:b.EventPresentation[0].LinkToDetailPage}),b.WebCastLink&&(d.webcast={url:b.WebCastLink}),d}}),a.widget("q4.financials",a.q4.api,{options:{reportTypes:[],docCategories:[],shortTypes:{"Annual Report":"Annual","Supplemental Report":"Supplemental","First Quarter":"Q1","Second Quarter":"Q2","Third Quarter":"Q3","Fourth Quarter":"Q4"}},dataUrl:"/Services/FinancialReportService.svc/GetFinancialReportList",yearsUrl:"/Services/FinancialReportService.svc/GetFinancialReportYearList",itemsResultField:"GetFinancialReportListResult",yearsResultField:"GetFinancialReportYearListResult",dateField:"ReportDate",_buildParams:function(){var b=this.options;return a.extend(this._super(),{reportSubTypeList:b.reportTypes})},_parseItem:function(b){var c=this,d=this.options;return{coverUrl:b.CoverImagePath,date:this._formatDate(b.ReportDate),title:b.ReportTitle,year:b.ReportYear,type:b.ReportSubType,shortType:d.shortTypes[b.ReportSubType],docs:a.map(b.Documents,function(a){return{docCategory:a.DocumentCategory,docSize:a.DocumentFileSize,docThumb:a.DocumentThumbnailPath,docTitle:c._truncate(a.DocumentTitle,d.titleLength),docType:a.DocumentFileType,docUrl:a.DocumentPath}})}},_buildTemplateData:function(b){function c(b){var c=[],e={};return a.each(b,function(b,d){-1==a.inArray(d.type,c)&&(c.push(d.type),e[d.type]=[]),a.each(d.docs,function(a,b){e[d.type].push(b)})}),a.map(c,function(a){return{type:a,shortType:d.shortTypes[a],items:e[a]}})}var d=this.options,e=this._super(b);return e.types=c(e.items),a.each(e.years,function(a,b){b.types=c(b.items)}),e}}),a.widget("q4.presentations",a.q4.api,{options:{},dataUrl:"/Services/PresentationService.svc/GetPresentationList",yearsUrl:"/Services/PresentationService.svc/GetPresentationYearList",itemsResultField:"GetPresentationListResult",yearsResultField:"GetPresentationYearListResult",dateField:"PresentationDate",_buildParams:function(){var b=this.options;return a.extend(this._super(),{presentationSelection:b.showFuture&&!b.showPast?0:b.showPast&&!b.showFuture?1:3})},_parseItem:function(a){var b=this.options;return{title:this._truncate(a.Title,b.titleLength),url:a.LinkToDetailPage,date:this._formatDate(a.PresentationDate),tags:a.TagsList,body:this._truncate(a.Body,b.bodyLength),docUrl:a.DocumentPath}}}),a.widget("q4.news",a.q4.api,{options:{category:"00000000-0000-0000-0000-000000000000",loadBody:!0,loadShortBody:!0,bodyLength:0,shortBodyLength:0},dataUrl:"/Services/PressReleaseService.svc/GetPressReleaseList",yearsUrl:"/Services/PressReleaseService.svc/GetPressReleaseYearList",itemsResultField:"GetPressReleaseListResult",yearsResultField:"GetPressReleaseYearListResult",dateField:"PressReleaseDate",_buildParams:function(){var b=this.options;return a.extend(this._super(),{pressReleaseSelection:b.showFuture&&!b.showPast?0:b.showPast&&!b.showFuture?1:3,pressReleaseBodyType:b.loadShortBody?b.loadBody?1:3:b.loadBody?2:0,pressReleaseCategoryWorkflowId:b.category})},_parseItem:function(a){var b=this.options;return{title:this._truncate(a.Headline,b.titleLength),url:a.LinkToDetailPage,date:this._formatDate(a.PressReleaseDate),tags:a.TagsList,body:this._truncate(a.Body,b.bodyLength),shortBody:this._truncate(a.ShortBody,b.shortBodyLength),docUrl:a.DocumentPath,docSize:a.DocumentFileSize,docType:a.DocumentFileType,thumb:a.ThumbnailPath||b.defaultThumb}}})}(jQuery);