/*
Widget:   q4.historical
Version:  2.0.0
Compiled: 2015-03-02
*/
!function(a){a.widget("q4.historical",{options:{exchange:"",symbol:"",dateFormat:"M d, yy",startDate:null,endDate:null,datepicker:"input:first",datepickerOpts:{},trigger:"",quoteContainer:".quote",quoteTemplate:"",notFoundMessage:"No stock data is available for this date."},_init:function(){function b(a){a.preventDefault();var b=g.datepicker("getDate");null!==b&&c._fetchQuote(b).done(function(a){c._renderQuote(a)})}var c=this,d=this.options,e=this.element;if(!d.exchange||!d.symbol){var f=document.location.search.match(/(?:^|&)Indice=([a-z]+):([a-z]+)(?:$|&)/i);if(!f)return void console.log("Error initializing stock historical chart: no exchange/symbol found.");d.exchange=d.exchange||f[1],d.symbol=d.symbol||f[2]}var g=a(d.datepicker,e).val("").datepicker(a.extend({},{minDate:null===d.startDate?null:new Date(d.startDate),maxDate:null===d.endDate?0:new Date(d.endDate),dateFormat:d.dateFormat,changeMonth:!0,changeYear:!0},d.datepickerOpts)),h=a(d.trigger,e);d.trigger&&h.length?h.click(b):g.change(b),c._fetchQuote(new Date).done(function(a){c._renderQuote(a)})},_fetchQuote:function(b){var c=this.options;return a.ajax({type:"POST",url:"/services/StockQuoteService.svc/GetStockQuoteHistoricalList",data:JSON.stringify({serviceDto:{RevisionNumber:GetRevisionNumber(),LanguageId:GetLanguageId(),Signature:GetSignature(),ViewType:GetViewType(),ViewDate:GetViewDate(),StartIndex:0,ItemCount:1},exchange:c.exchange,symbol:c.symbol,endDate:"/Date("+b.getTime()+")/"}),contentType:"application/json; charset=utf-8",dataType:"json"})},_renderQuote:function(b){var c=this.options,d=this.element;return b.GetStockQuoteHistoricalListResult.length?(b=b.GetStockQuoteHistoricalListResult[0],void a(c.quoteContainer,d).html(Mustache.render(c.quoteTemplate,{date:a.datepicker.formatDate(c.dateFormat,new Date(b.HistoricalDate)),high:b.High,low:b.Low,open:b.Open,close:b.Last,volume:this._addCommas(b.Volume)}))):void a(c.quoteContainer,d).html(c.notFoundMessage)},_addCommas:function(a){for(var b=(""+a).split("."),c=b[0],d=b[1],e=/(\d+)(\d{3})/;e.test(c);)c=c.replace(e,"$1,$2");return c+(d?"."+d:"")}})}(jQuery);