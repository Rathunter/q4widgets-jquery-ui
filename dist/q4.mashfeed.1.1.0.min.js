/*
Widget:   q4.mashfeed
Version:  1.1.0
Compiled: 2015-02-18
*/
!function(a){a.widget("q4.mashfeed",{options:{limit:0,dateFormat:"MMM D, YYYY h:mm A",fromNow:!1,titleLength:80,summaryLength:500,feeds:[],filter:[],template:"",complete:function(){}},feedTypes:{rss:{fetch:function(b){return a.ajax({url:"https://ajax.googleapis.com/ajax/services/feed/load?v=1.0&q="+encodeURIComponent(b.url),dataType:"jsonp"})},getItems:function(a){return a.responseData.feed.entries},parseItem:function(a){return{title:a.title,url:a.link,date:moment(a.publishedDate,"DD MMM YYYY hh:mm:ss"),content:a.content}}},twitter:{fetch:function(b){return a.ajax({url:b.url,dataType:"jsonp"})},getItems:function(a){return a},parseItem:function(a){return{user:a.user.screen_name,username:a.user.name,content:a.text.replace(/https?:\/\/[\S]+/gi,'<a href="$&" target="_blank">$&</a>').replace(/#(\w*)/g,'<a href="https://twitter.com/hashtag/$1" target="_blank">#$1</a>').replace(/@(\w*)/g,'<a href="https://twitter.com/$1" target="_blank">@$1</a>'),date:moment(a.created_at,"ddd MMM DD hh:mm:ss ZZ YYYY"),id:a.id_str}}},stocktwits:{fetch:function(b){return a.ajax({url:"https://api.stocktwits.com/api/2/streams/symbol/"+b.symbol+".json",dataType:"jsonp"})},getItems:function(a){return a.messages},parseItem:function(a){return{user:a.user.username,username:a.user.name,content:a.body,date:moment(a.created_at),id:a.id}}},facebook:{fetch:function(b){return a.ajax({url:b.url,dataType:"jsonp"})},getItems:function(a){return a},parseItem:function(a){return{url:a.link,id:a.id,date:moment(a.created_time),type:a.type,content:a.message,thumb:a.picture}}},youtube:{fetch:function(b){return a.ajax({url:"https://gdata.youtube.com/feeds/users/"+b.username+"/uploads?alt=json-in-script&callback=?",dataType:"jsonp"})},getItems:function(a){return a.feed.entry},parseItem:function(b){return{title:b.title.$t,url:b.link[0].href,id:b.id.$t.split("/").pop(),date:moment(b.updated.$t),content:b.content.$t,thumb:a(b.content.$t).find("img").first().attr("src")}}},custom_jsonp:{fetch:function(b){return a.ajax({url:b.url,data:b.params,dataType:"jsonp"})},getItems:function(a){return a},parseItem:function(a){return a}}},items:[],updateFilter:function(a){this.options.filter=a||[],this._renderFeeds()},_init:function(){var a=this;this._fetchFeeds().done(function(){a._renderFeeds()})},_fetchFeeds:function(){var b=this,c=this.options;this.items=[];var d=a.map(c.feeds,function(a){return"function"==typeof a.fetch?a.fetch.call(b,a):b.feedTypes[a.type].fetch.call(b,a)});return a.when.apply(a,d).done(function(){var e=d.length>1?arguments:[arguments];a.each(e,function(d,e){var f=e[0],g=c.feeds[d],h=b.feedTypes[g.type],i="function"==typeof g.getItems?g.getItems.call(b,f):h.getItems.call(b,f);c.limit&&(i=i.slice(0,c.limit)),g.limit&&(i=i.slice(0,g.limit)),a.each(i,function(c,d){b.items.push(a.extend({feed:g},"function"==typeof g.parseItem?g.parseItem.call(b,d):h.parseItem.call(b,d)))})}),b.items.sort(function(a,b){return b.date.diff(a.date)})})},_renderFeeds:function(){function b(a,b){return!b||a.length<b?a:a.slice(0,b).split(/\s+/).slice(0,-1).join(" ")+"..."}var c=this.options,d=this.element.empty();a.isArray(c.filter)||(c.filter=[c.filter]);var e=a.grep(this.items,function(b){return!c.filter.length||a.inArray(b.feed.name,c.filter)>-1});a.each(c.limit?e.slice(0,c.limit):e,function(e,f){var g={};if("title"in f&&(g.title=b(f.title,f.feed.titleLength||c.titleLength)),"date"in f&&(g.date=c.fromNow?f.date.fromNow():f.date.format(c.dateFormat)),"content"in f){var h=a.trim(a("<div>").html(f.content).text());g.summary=b(h,f.feed.summaryLength||c.summaryLength),g.firstLine=h.split("\n")[0]}d.append(Mustache.render(f.feed.template||c.template,a.extend({},f,g)))}),this._trigger("complete")}})}(jQuery);