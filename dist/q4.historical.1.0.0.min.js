/*
Widget:   q4.historical
Version:  1.0.0
Compiled: 2015-02-04
*/
!function(a){a.widget("q4.historical",{options:{symbol:"",exchange:"",loading:'<img src="//q4widgets.q4web.com/historicalQuote/img/ajax-loader.gif" alt="loading..." />',invalidText:"<span>Invalid date range</span>",noDataText:"<span>There is no data for the selected date.</span>",range:!1,maxItems:-1,dateFormat:"mm/dd/yy",selects:{startYear:(new Date).getFullYear()-10,btnCLs:"lookup",data:[{name:"Jan",num:1,days:31},{name:"Feb",num:2,days:function(a){return 1==new Date(a,1,29).getMonth()?29:28}},{name:"Mar",num:3,days:31},{name:"Apr",num:4,days:30},{name:"May",num:5,days:31},{name:"Jun",num:6,days:30},{name:"Jul",num:7,days:31},{name:"Aug",num:8,days:31},{name:"Sep",num:9,days:30},{name:"Oct",num:10,days:31},{name:"Nov",num:11,days:30},{name:"Dec",num:12,days:31}],monthTpl:'<select class="month">{{#data}}<option value="{{num}}">{{name}}</option>{{/data}}</select>',onMonthChange:function(b){var c=b.options,d=c.range?[b.element.find(".stock-start select"),b.element.find(".stock-end select")]:[b.element.find(".stock-selects select")];a.each(d,function(a,d){d.not(".day").on("change",function(){var a=c.selects.data[parseInt(d.filter(".month").val())-1];a=void 0!==a.days&&"function"==typeof a.days?a.days(d.filter(".year").val()):a.days,d.filter("select.day").html(Mustache.render(c.selects.dayTpl,b.buildArrayAdd(1,a))),void 0!==b.options.onSelectUpdate&&"function"==typeof b.options.onSelectUpdate&&b.options.onSelectUpdate()})})},dayTpl:'<select class="day">{{#count}}<option value="{{.}}">{{.}}</option>{{/count}}</select>',yearTpl:'<select class="year">{{#count}}<option value="{{.}}">{{.}}</option>{{/count}}</select>'},stockTableClass:"stock-table",rangeTpl:function(a,b,c){return'<div class="stock-historical"><div class="stock-selects"><div class="stock-start"><span class="text">Start Date:</span>'+a+b+c+'</div><div class="stock-end"><span class="text">End Date:</span>'+a+b+c+'</div><button class="'+this.selects.btnCLs+'">Look Up</button></div><div class="'+this.stockTableClass+'">'+this.loading+"</div></div>"},moduleTpl:function(a,b,c){return'<div class="stock-historical"><div class="stock-selects"><span class="text">Lookup Date</span>'+a+b+c+'<button class="'+this.selects.btnCLs+'">Look Up</button></div><div class="'+this.stockTableClass+'">'+this.loading+"</div></div>"},stockHeader:"",stockTpl:'<ul class="list-group"><li class="list-group-item"><span class="text">Date</span><span class="badge">{{Day}}</span></li><li class="list-group-item"><span class="text">Day\'s High</span><span class="badge">{{High}}</span></li><li class="list-group-item alt"><span class="text">Day\'s Low</span><span class="badge">{{Low}}</span></li><li class="list-group-item"><span class="text">Volume</span><span class="badge">{{Volume}}</span></li><li class="list-group-item alt"><span class="text">Open</span><span class="badge">{{Open}}</span></li><li class="list-group-item"><span class="text">Closing Price</span><span class="badge">{{Last}}</span></li></ul>',onDataLoad:function(){},onFirstLoad:function(){},onSelectUpdate:function(){},beforeAjaxCall:function(){}},_create:function(){this.buildHTML()},_init:function(){this.getHistoricalData()},_loaded:!1,addCommas:function(a){a+="",x=a.split("."),x1=x[0],x2=x.length>1?"."+x[1]:"";for(var b=/(\d+)(\d{3})/;b.test(x1);)x1=x1.replace(b,"$1,$2");return x1+x2},queryStringToObj:function(a){var b=a.split("&"),c={},d="";for(i=0;i<b.length;i++)d=b[i].split("="),c[d[0]]=d[1];return c},onRangeRefresh:function(){var b=this,c=b.options,d=c.range?[b.element.find(".stock-start"),b.element.find(".stock-end")]:[b.element.find(".stock-selects")];b.element.find("button."+c.selects.btnCLs).on("click",function(e){var f=[];e.preventDefault(),a("."+b.options.stockTableClass).html(b.options.loading),a.each(d,function(){f.push(new Date(a(this).find(".month").val()+"/"+a(this).find(".day").val()+"/"+a(this).find(".year").val()))}),c.range?b.getHistoricalData("/Date("+f[0].setHours(0,0,0,0)+")/","/Date("+f[1].setHours(1,0,0,0)+")/"):b.getHistoricalData("/Date("+f[0].setHours(0,0,0,0)+")/","/Date("+f[0].setHours(1,0,0,0)+")/")})},setSelectDate:function(a){this.element.find("select.month").val(parseInt(a.split("/")[0])),this.element.find("select.day").val(parseInt(a.split("/")[1]))},buildArrayAdd:function(a,b){var c=[];for(i=a;i<=b;i++)c.push(i);return data={count:c}},buildArraySub:function(a,b){var c=[];for(i=a;i>=b;i--)c.push(i);return data={count:c}},dataDto:function(){return dataObj={serviceDto:{RevisionNumber:GetRevisionNumber(),LanguageId:GetLanguageId(),Signature:GetSignature(),ViewType:GetViewType(),ViewDate:GetViewDate(),StartIndex:0,ItemCount:1},exchange:this.options.exchange,symbol:this.options.symbol}},buildHTML:function(){var a=this,b=a.options.selects,c=Mustache.render(b.monthTpl,b),d=Mustache.render(b.dayTpl,a.buildArrayAdd(1,b.data[(new Date).getMonth()].days)),e=Mustache.render(b.yearTpl,a.buildArraySub((new Date).getFullYear(),b.startYear));a.element.html(a.options.range?this.options.rangeTpl(c,d,e):this.options.moduleTpl(c,d,e)),b.onMonthChange(a),void 0!==a.options.onFirstLoad&&"function"==typeof a.options.onFirstLoad&&a.options.onFirstLoad(a)},getHistoricalData:function(b,c){var d=this,e=d.dataDto(),f=d.queryStringToObj(location.href.toLowerCase().split("?").pop());void 0!==f.indice&&(e.exchange=f.indice.split(":").shift(),e.symbol=f.indice.split(":").pop()),void 0!==b&&(e.startDate=b,e.endDate=c),d.options.range&&d._loaded&&(e.serviceDto.ItemCount=d.options.maxItems),void 0!==d.options.beforeAjaxCall&&"function"==typeof d.options.beforeAjaxCall&&d.options.beforeAjaxCall(d),a.ajax({type:"POST",url:"/services/StockQuoteService.svc/GetStockQuoteHistoricalList",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",dataType:"json",success:function(a){a=a.GetStockQuoteHistoricalListResult,d.buildStockTable(a),!d._loaded&&a.length&&(d._loaded=!0,d.setSelectDate(a[0].HistoricalDate.split(" ").shift()),d.onRangeRefresh()),void 0!==d.options.onDataLoad&&"function"==typeof d.options.onDataLoad&&d.options.onDataLoad(d,a)},error:function(){d.element.find("."+d.options.stockTableClass).html(d.options.invalidText)}})},buildStockTable:function(b){var c=this,d=c.options.stockHeader;void 0!==b&&b.length?a.each(b,function(b,e){e.Day=a.datepicker.formatDate(c.options.dateFormat,new Date(e.HistoricalDate)),e.High=e.High.toFixed(2),e.Last=e.Last.toFixed(2),e.Low=e.Low.toFixed(2),e.Open=e.Open.toFixed(2),e.Volume=c.addCommas(e.Volume),d+=Mustache.render(c.options.stockTpl,e)}):d=c.options.noDataText,c.element.find("."+c.options.stockTableClass).html(d)},destroy:function(){this.element.html("")},_setOption:function(){this._superApply(arguments)}})}(jQuery);