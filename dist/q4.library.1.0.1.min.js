/*
Widget:   q4.library
Version:  1.0.1
Compiled: 2015-03-02
*/
!function(a){a.widget("q4.library",{options:{feedUrl:"",perPage:0,sortByYear:!0,allowAllYears:!0,allYearsText:"All",startYear:null,dateFormat:"MM/DD/YYYY",template:"",loadingTemplate:"Loading...",docsFoundContainer:".docsfound",docsFoundTemplate:"Showing {{docFirst}}–{{docLast}} of {{docTotal}} documents.",noDocsMessage:"No documents found. Please try broadening your search.",docContainer:".documents",singleDocTemplate:"",multiDocTemplate:"",accordionContainer:".multi",accordionTrigger:".trigger",accordionDocContainer:".docs",pagerContainer:".pager",pagerTrigger:"> *",pagerTemplate:"<li>{{page}}</li>",pagerLabels:{first:"«",prev:"<",next:">",last:"»"},perPageOptions:{container:".perpage",input:"select",template:"<option>{{number}}</option>",trigger:"> *",allowMulti:!1,allowNone:!1},searchSelector:".search",categories:["contentAssets","events","financialReports","presentations","pressReleases"],catOptions:{container:".content-types",input:"trigger",template:"<li>{{name}}</li>",trigger:"> *",allowMulti:!1,allowNone:!1},tags:[],tagOptions:{container:".tags",input:"trigger",template:"<li>{{name}}</li>",trigger:"> *",allowMulti:!0,allowNone:!0},yearOptions:{container:".years",input:"select",template:'<option value="{{value}}">{{year}}</option>',trigger:"> *",allowMulti:!1,allowNone:!1},onFilterUpdate:function(){},pageComplete:function(){}},contentTypes:{contentAssets:{name:"Downloads",multiple:!1,parse:function(a,b){return{title:a.Title,date:moment(a.ContentAssetDate).format(b.dateFormat),list:a.Type,url:a.FilePath,type:a.FileType,size:a.FileSize}}},events:{name:"Events",multiple:!0,parse:function(b,c){return b.EventPresentation.length||b.Attachments.length?(docs=[],a.each(b.EventPresentation,function(a,b){docs.push({title:b.Title,url:b.DocumentPath,type:b.DocumentFileType,size:b.DocumentFileSize})}),a.each(b.Attachments,function(a,b){docs.push({title:b.Title,url:b.Url,type:b.Extension,size:b.Size})}),{title:b.Title,date:moment(b.StartDate).format(c.dateFormat),subdocs:docs}):void 0}},financialReports:{name:"Financial Reports",multiple:!0,parse:function(b,c){return b.Documents.length?(docs=[],a.each(b.Documents,function(a,b){docs.push({title:b.DocumentTitle,url:b.DocumentPath,type:b.DocumentFileType,size:b.DocumentFileSize})}),{title:b.ReportTitle,date:moment(b.ReportDate).format(c.dateFormat),subdocs:docs}):void 0}},presentations:{name:"Presentations",multiple:!1,parse:function(a,b){return{title:a.Title,date:moment(a.PresentationDate).format(b.dateFormat),url:a.DocumentPath,type:a.DocumentFileType,size:a.DocumentFileSize}}},pressReleases:{name:"Press Releases",multiple:!1,parse:function(a,b){return"DocumentPath"in a&&a.DocumentPath.length?{title:a.Headline,date:moment(a.PressReleaseDate).format(b.dateFormat),url:a.DocumentPath,type:a.DocumentFileType,size:a.DocumentFileSize}:void 0}}},setFilter:function(a,b,c){"category"==a&&(a="cat"),"tags"==a&&(a="tag"),this._setInput(a,b),this._updateFilterFromInput(a,c)},_create:function(){var b=this.options;a.ajaxSetup({cache:!0}),b.feedUrl=b.feedUrl.replace(/\/$/,""),this.filterOpts={cat:b.catOptions,tag:b.tagOptions,year:b.yearOptions,perPage:b.perPageOptions,search:{container:b.searchSelector,input:"text"}},this._drawLibrary(),this._bindEvents(),this._countAndLoadDocuments()},_drawLibrary:function(){var b=this,c=this.element,d=this.options;c.html(Mustache.render(d.template));var e=["select","trigger","text"];a.each([d.catOptions,d.tagOptions,d.yearOptions],function(b,c){-1==a.inArray(c.input,e)&&(c.input="trigger")}),c.data("search",a(d.searchSelector,c).val());var f=a(d.catOptions.container,c);a.each(d.categories,function(c,e){if("string"==typeof e&&e in b.contentTypes)e={name:b.contentTypes[e].name,contentType:e};else{if(!("object"==typeof e&&"contentType"in e&&e.contentType in b.contentTypes))return!0;"name"in e||(e.name=b.contentTypes[e.contentType].name)}"options"in e&&"object"==typeof e.options||(e.options={}),d.categories[c]=e,a(Mustache.render(d.catOptions.template,e)).data("cat",c).appendTo(f)}),this._setInput("cat",0),c.data("cat",0);var g=a(d.tagOptions.container,c);a.each(d.tags,function(b,c){if("string"==typeof c)c={name:c,value:c};else{if(!("object"==typeof c&&"value"in c))return!0;"name"in c||(c.name=c.value)}a(Mustache.render(d.tagOptions.template,c)).data("tag",c.value).appendTo(g)});var h=a(d.perPageOptions.container,c),i=[];a.each(a.isArray(d.perPage)?d.perPage:[d.perPage],function(a,b){parseInt(b)&&i.push(parseInt(b))}),i&&(a.each(i,function(b,c){a(Mustache.render(d.perPageOptions.template,{number:c})).data("perPage",c).appendTo(h)}),b._setInput("perPage",i[0]),c.data("perPage",i[0]))},_bindEvents:function(){var b=(this.element,this.options),c={};a.each(this.filterOpts,function(b,d){"select"==d.input||"text"==d.input?c["change "+d.container]=function(a){this._trigger("onFilterUpdate",a),a.isDefaultPrevented()||this._updateFilterFromInput(b,!0)}:"trigger"==d.input&&(c["click "+d.container+" "+d.trigger]=function(c){this._trigger("onFilterUpdate",c),c.isDefaultPrevented()||(this._setInput(b,a(c.target).data(b)),this._updateFilterFromInput(b,!0))})}),c["click "+b.docContainer+" "+b.accordionContainer+" "+b.accordionTrigger]=function(c){a(c.currentTarget).closest(b.accordionContainer).find(b.accordionDocContainer).slideToggle(200)},this._on(c)},_setInput:function(b,c){var d=this.element,e=this.filterOpts[b];if("select"==e.input||"text"==e.input)a(e.container,d).val(c);else if("trigger"==e.input){var f=a(e.container+" "+e.trigger,d),g=f.filter(function(){return a(this).data(b)==c});if(!e.allowNone&&g.hasClass("active")&&1==f.filter(".active").length)return;e.allowMulti||g.hasClass("active")||f.removeClass("active"),g.toggleClass("active")}},_updateFilterFromInput:function(b,c){var d=this.element,e=this.filterOpts[b];if("select"==e.input||"text"==e.input)d.data(b,a(e.container,d).val());else if("trigger"==e.input){var f=a(e.container+" "+e.trigger,d),g=[];f.filter(".active").each(function(){g=g.concat(a(this).data(b))}),d.data(b,g)}c&&("year"==b||"perPage"==b?(this._updateDocumentCount(),this._loadDocumentPage(1)):this._countAndLoadDocuments())},_countAndLoadDocuments:function(){var b=this,c=this.element,d=this.options,e=d.categories[c.data("cat")],f=a.extend({},e.options,{tag:c.data("tag")||[],year:c.data("year"),string:c.data("search")}),g=a(d.docContainer,c).html(d.loadingTemplate),h=a(d.docsFoundContainer,c).empty();a.ajax({url:d.feedUrl+"/"+e.contentType+"/years",data:f,traditional:!0,dataType:"jsonp",success:function(e){var f=[],i={};if(!e.length)return g.empty(),void h.html(d.noDocsMessage);d.allowAllYears&&(i[""]=0),a.each(e,function(a,b){f.push(b._id.year),i[b._id.year]=b.total,i[""]+=b.total}),c.data("yeartotals",i),c.data("years",f),b._updateDocumentCount();var j=a(d.yearOptions.container,c).empty();d.sortByYear&&j.length&&(d.allowAllYears&&a(Mustache.render(d.yearOptions.template,{value:"",year:d.allYearsText})).data("year","").appendTo(j),a.each(f,function(b,c){a(Mustache.render(d.yearOptions.template,{value:c,year:c})).data("year",c).appendTo(j)})),b._setInput("year",c.data("year")),b._loadDocumentPage(1)}})},_updateDocumentCount:function(){var b=this,c=this.options,d=this.element,e=a(c.pagerContainer,d).empty();-1!=a.inArray(parseInt(d.data("year")),d.data("years"))||""==d.data("year")&&c.allowAllYears||d.data("year",a.inArray(c.startYear,d.data("years"))>-1?c.startYear:d.data("years").length&&!c.allowAllYears?d.data("years")[0]:""),d.data("perPage")&&e.length&&e.pager({count:d.data("yeartotals")[d.data("year")],perPage:d.data("perPage"),trigger:c.pagerTrigger,template:c.pagerTemplate,labels:c.pagerLabels,beforeChange:function(a,c){b._loadDocumentPage(c)}})},_loadDocumentPage:function(b){var c=this,d=c.element,e=c.options,f=e.categories[d.data("cat")],g=this.contentTypes[f.contentType],h=a.extend({},f.options,{tag:d.data("tag")||[],year:d.data("year"),string:d.data("search"),skip:d.data("perPage")?(b-1)*d.data("perPage"):0,limit:d.data("perPage")||0}),i=a(e.docContainer,d).html(e.loadingTemplate),j=a(e.docsFoundContainer,d).empty();a.ajax({url:e.feedUrl+"/"+f.contentType+"/search",data:h,traditional:!0,dataType:"jsonp",success:function(k){var l="template"in f?f.template:g.multiple?e.multiDocTemplate:e.singleDocTemplate,m=[],n=d.data("yeartotals")[d.data("year")]||0;a.each(k,function(a,b){var c=g.parse(b.Q4Dto,e);c&&m.push(c)}),i.html(Mustache.render(l,{docs:m})),"cssClass"in f&&(d.removeClass(d.data("catClass")),d.addClass(f.cssClass).data("catClass",f.cssClass)),j.html(Mustache.render(e.docsFoundTemplate,{docCount:m.length,docTotal:n,docFirst:h.skip+1,docLast:h.skip+m.length,page:b,pageCount:Math.ceil(n/d.data("perPage"))})),c._trigger("pageComplete")}})}})}(jQuery);